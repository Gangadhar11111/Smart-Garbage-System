<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Management dApp</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; background-color: #f4f7f6; }
        .card { border: none; padding: 20px; border-radius: 12px; margin-bottom: 20px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2, h3 { color: #2c3e50; margin-top: 0; }
        input, select, button { display: block; width: 100%; margin: 12px 0; padding: 12px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        button { background: #2ecc71; color: white; border: none; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        button:hover { background: #27ae60; }
        .admin-btn { background: #3498db; }
        .remove-btn { background: #e74c3c; }
        .status { font-weight: bold; color: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        #walletAddress { font-size: 0.85rem; word-break: break-all; color: #7f8c8d; }
    </style>
</head>
<body>

    <h2>üåç Waste Management System</h2>
    
    <div id="accountArea" class="card">
        <button id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
        <p id="walletAddress">Status: Not Connected</p>
    </div>

    <div class="card">
        <h3>üìù Record New Waste</h3>
        <input type="number" id="binId" placeholder="Bin ID">
        <input type="text" id="location" placeholder="Location Name">
        <select id="wasteType">
            <option value="0">Biodegradable</option>
            <option value="1">Non-Biodegradable</option>
            <option value="2">Recyclable</option>
            <option value="3">Non-Recyclable</option>
        </select>
        <input type="number" id="weight" placeholder="Weight (kg)">
        <input type="number" id="collectorId" placeholder="Collector ID">
        <button onclick="recordWaste()">Submit to Blockchain</button>
    </div>

    <div class="card">
        <h3>üìä Records Summary</h3>
        <p>Total Records: <span id="recordCount" class="status">0</span></p>
        <button class="admin-btn" onclick="fetchAllRecords()">View All Records</button>
        <div id="recordsList"></div>
    </div>

    <div class="card" style="border-top: 4px solid #3498db;">
        <h3>üõ°Ô∏è Admin Tools</h3>
        <input type="text" id="collectorAddr" placeholder="Collector Wallet Address">
        <button class="admin-btn" onclick="manageCollector(true)">Authorize Collector</button>
        <button class="remove-btn" onclick="manageCollector(false)">Revoke Authorization</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" type="text/javascript"></script>

    <script>
        const contractAddress = "0x3cA38E089Cd3BF3cF24Dabc40dF0c988075b2729";
        const abi = [
            "function addCollector(address _collector) public",
            "function removeCollector(address _collector) public",
            "function recordWaste(uint256 _binId, string _location, uint8 _wasteType, uint256 _weight, bool _collectionStatus, uint256 _collectorId) public",
            "function getRecordCount() public view returns (uint256)",
            "function records(uint256) public view returns (uint256 binId, string location, uint256 timestamp, uint8 wasteType, uint256 weight, bool collectionStatus, uint256 collectorId)",
            "function admin() public view returns (address)"
        ];

        let provider, signer, contract;
        const wasteTypes = ["Biodegradable", "Non-Biodegradable", "Recyclable", "Non-Recyclable"];

        async function connectWallet() {
            // Check if ethers library loaded correctly
            if (typeof ethers === 'undefined') {
                alert("The Ethers.js library failed to load. Please check your internet connection.");
                return;
            }

            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();
                    const address = await signer.getAddress();
                    
                    document.getElementById("walletAddress").innerText = "Connected: " + address;
                    document.getElementById("connectBtn").innerText = "Wallet Linked";
                    
                    contract = new ethers.Contract(contractAddress, abi, signer);
                    updateRecordCount();
                } catch (error) {
                    alert("Connection failed: " + error.message);
                }
            } else {
                alert("MetaMask not detected!");
            }
        }

        async function updateRecordCount() {
            if (!contract) return;
            const count = await contract.getRecordCount();
            document.getElementById("recordCount").innerText = count.toString();
        }

        async function recordWaste() {
            if (!contract) return alert("Connect wallet first!");
            try {
                const tx = await contract.recordWaste(
                    document.getElementById("binId").value, 
                    document.getElementById("location").value, 
                    document.getElementById("wasteType").value, 
                    document.getElementById("weight").value, 
                    true, 
                    document.getElementById("collectorId").value
                );
                await tx.wait();
                alert("Record added!");
                updateRecordCount();
            } catch (err) {
                alert("Error: " + (err.reason || "Transaction failed. Only authorized collectors can record waste."));
            }
        }

        async function fetchAllRecords() {
            if (!contract) return alert("Connect wallet first!");
            const count = await contract.getRecordCount();
            let html = `<table><tr><th>Bin ID</th><th>Type</th><th>Weight</th><th>Time</th></tr>`;
            for (let i = 0; i < count; i++) {
                const r = await contract.records(i);
                html += `<tr><td>${r.binId}</td><td>${wasteTypes[r.wasteType]}</td><td>${r.weight}kg</td><td>${new Date(r.timestamp * 1000).toLocaleDateString()}</td></tr>`;
            }
            html += `</table>`;
            document.getElementById("recordsList").innerHTML = html;
        }

        async function manageCollector(isAdding) {
            if (!contract) return alert("Connect wallet first!");
            try {
                const addr = document.getElementById("collectorAddr").value;
                const tx = isAdding ? await contract.addCollector(addr) : await contract.removeCollector(addr);
                await tx.wait();
                alert("Collector status updated!");
            } catch (err) {
                alert("Error: " + (err.reason || "Admin access required."));
            }
        }
    </script>
</body>
</html>
