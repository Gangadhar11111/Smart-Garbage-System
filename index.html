<!DOCTYPE html>
<html>
<head>
    <title>Waste Management DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
    <style>
        body {
            font-family: Arial;
            background: #f4f6f9;
            padding: 20px;
        }
        h2 { color: #2c3e50; }
        .box {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 5px #ccc;
        }
        input, select, button {
            margin: 5px 0;
            padding: 8px;
            width: 100%;
        }
        button {
            background: #27ae60;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background: #219150; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }
        th { background: #27ae60; color: white; }
    </style>
</head>
<body>

<h2>Waste Management DApp</h2>

<button onclick="connectWallet()">Connect Wallet</button>
<p id="walletAddress"></p>
<p id="roleInfo"></p>

<div class="box" id="adminSection" style="display:none;">
    <h3>Admin Controls</h3>
    <input type="text" id="collectorAddress" placeholder="Collector Address">
    <button onclick="addCollector()">Add Collector</button>

    <input type="text" id="removeCollectorAddress" placeholder="Collector Address">
    <button onclick="removeCollector()">Remove Collector</button>
</div>

<div class="box">
    <h3>Record Waste</h3>
    <input type="number" id="binId" placeholder="Bin ID">
    <input type="text" id="location" placeholder="Location">

    <select id="wasteType">
        <option value="0">Biodegradable</option>
        <option value="1">NonBiodegradable</option>
        <option value="2">Recyclable</option>
        <option value="3">NonRecyclable</option>
    </select>

    <input type="number" id="weight" placeholder="Weight">

    <select id="collectionStatus">
        <option value="true">Collected</option>
        <option value="false">Not Collected</option>
    </select>

    <input type="number" id="collectorId" placeholder="Collector ID">

    <button onclick="recordWaste()">Submit Waste</button>
</div>

<div class="box">
    <h3>Waste Records</h3>
    <button onclick="loadRecords()">Load Records</button>
    <table>
        <thead>
            <tr>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Time</th>
                <th>Type</th>
                <th>Weight</th>
                <th>Status</th>
                <th>Collector ID</th>
            </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
    </table>
</div>

<script>
let provider;
let signer;
let contract;

const contractAddress = "0x3cA38E089Cd3BF3cF24Dabc40dF0c988075b2729";

const contractABI = [PASTE_YOUR_FULL_ABI_HERE];

const wasteTypes = ["Biodegradable","NonBiodegradable","Recyclable","NonRecyclable"];

async function connectWallet() {
    if (!window.ethereum) return alert("Install MetaMask");

    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    contract = new ethers.Contract(contractAddress, contractABI, signer);

    const address = await signer.getAddress();
    document.getElementById("walletAddress").innerText = "Connected: " + address;

    checkRole(address);
    listenToEvents();
}

async function checkRole(address) {
    const admin = await contract.admin();
    if (address.toLowerCase() === admin.toLowerCase()) {
        document.getElementById("roleInfo").innerText = "Role: ADMIN";
        document.getElementById("adminSection").style.display = "block";
    } else {
        const isCollector = await contract.collectors(address);
        if (isCollector) {
            document.getElementById("roleInfo").innerText = "Role: COLLECTOR";
        } else {
            document.getElementById("roleInfo").innerText = "Role: USER";
        }
    }
}

async function addCollector() {
    try {
        const addr = document.getElementById("collectorAddress").value;
        const tx = await contract.addCollector(addr);
        await tx.wait();
        alert("Collector Added");
    } catch (err) { alert(err.message); }
}

async function removeCollector() {
    try {
        const addr = document.getElementById("removeCollectorAddress").value;
        const tx = await contract.removeCollector(addr);
        await tx.wait();
        alert("Collector Removed");
    } catch (err) { alert(err.message); }
}

async function recordWaste() {
    try {
        const binId = parseInt(document.getElementById("binId").value);
        const location = document.getElementById("location").value;
        const wasteType = parseInt(document.getElementById("wasteType").value);
        const weight = parseInt(document.getElementById("weight").value);
        const collectionStatus =
            document.getElementById("collectionStatus").value === "true";
        const collectorId = parseInt(document.getElementById("collectorId").value);

        const tx = await contract.recordWaste(
            binId,
            location,
            wasteType,
            weight,
            collectionStatus,
            collectorId
        );

        await tx.wait();
        alert("Waste Recorded Successfully");
        loadRecords();
    } catch (err) { alert(err.message); }
}

async function loadRecords() {
    const count = await contract.getRecordCount();
    const table = document.getElementById("recordsTable");
    table.innerHTML = "";

    for (let i = 0; i < count; i++) {
        const record = await contract.records(i);

        const row = `<tr>
            <td>${record.binId}</td>
            <td>${record.location}</td>
            <td>${new Date(record.timestamp * 1000).toLocaleString()}</td>
            <td>${wasteTypes[record.wasteType]}</td>
            <td>${record.weight}</td>
            <td>${record.collectionStatus ? "Collected" : "Pending"}</td>
            <td>${record.collectorId}</td>
        </tr>`;

        table.innerHTML += row;
    }
}

function listenToEvents() {
    contract.on("WasteRecorded", () => {
        loadRecords();
    });
}
</script>

</body>
</html>
