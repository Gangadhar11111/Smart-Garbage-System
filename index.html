<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Management dApp</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; line-height: 1.6; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #f9f9f9; }
        input, select, button { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #218838; }
        .status { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

    <h2>Waste Management System</h2>
    <div id="accountArea" class="card">
        <button onclick="connectWallet()">Connect Wallet</button>
        <p id="walletAddress">Not Connected</p>
    </div>

    <div class="card">
        <h3>Record Waste</h3>
        <input type="number" id="binId" placeholder="Bin ID">
        <input type="text" id="location" placeholder="Location">
        <select id="wasteType">
            <option value="0">Biodegradable</option>
            <option value="1">Non-Biodegradable</option>
            <option value="2">Recyclable</option>
            <option value="3">Non-Recyclable</option>
        </select>
        <input type="number" id="weight" placeholder="Weight (kg)">
        <input type="number" id="collectorId" placeholder="Collector ID">
        <button onclick="recordWaste()">Submit Record</button>
    </div>

    <div class="card">
        <h3>Admin Tools</h3>
        <input type="text" id="collectorAddr" placeholder="Collector Wallet Address">
        <button onclick="manageCollector(true)">Add Collector</button>
        <button onclick="manageCollector(false)" style="background:#dc3545">Remove Collector</button>
    </div>

    <div class="card">
        <button onclick="fetchRecordCount()">Update Total Records</button>
        <p>Total Records on Blockchain: <span id="recordCount" class="status">0</span></p>
    </div>

    <script>
        const contractAddress = "0x3cA38E089Cd3BF3cF24Dabc40dF0c988075b2729";
        const abi = [
            "function addCollector(address _collector) public",
            "function removeCollector(address _collector) public",
            "function recordWaste(uint256 _binId, string _location, uint8 _wasteType, uint256 _weight, bool _collectionStatus, uint256 _collectorId) public",
            "function getRecordCount() public view returns (uint256)",
            "function admin() public view returns (address)"
        ];

        let provider, signer, contract;

        async function connectWallet() {
            if (window.ethereum) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                document.getElementById("walletAddress").innerText = "Connected: " + address;
                contract = new ethers.Contract(contractAddress, abi, signer);
                fetchRecordCount();
            } else {
                alert("Please install MetaMask!");
            }
        }

        async function recordWaste() {
            try {
                const binId = document.getElementById("binId").value;
                const location = document.getElementById("location").value;
                const wasteType = document.getElementById("wasteType").value;
                const weight = document.getElementById("weight").value;
                const collectorId = document.getElementById("collectorId").value;

                const tx = await contract.recordWaste(
                    binId, 
                    location, 
                    wasteType, 
                    weight, 
                    true, // Defaulting collection status to true for this demo
                    collectorId
                );
                alert("Transaction sent! Hash: " + tx.hash);
                await tx.wait();
                alert("Waste Recorded Successfully!");
                fetchRecordCount();
            } catch (err) {
                console.error(err);
                alert("Error: " + err.reason || err.message);
            }
        }

        async function manageCollector(isAdding) {
            try {
                const addr = document.getElementById("collectorAddr").value;
                const tx = isAdding ? await contract.addCollector(addr) : await contract.removeCollector(addr);
                alert("Processing...");
                await tx.wait();
                alert("Collector Status Updated!");
            } catch (err) {
                console.error(err);
                alert("Admin only or invalid address.");
            }
        }

        async function fetchRecordCount() {
            if (!contract) return;
            const count = await contract.getRecordCount();
            document.getElementById("recordCount").innerText = count.toString();
        }
    </script>
</body>
</html>
